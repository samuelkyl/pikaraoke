{% extends 'base.html' %} {% block scripts %}
<script>
  var transpose_seeking = false;
  var seektrack_seeking = false;
  var audiodelay_typing = false;
  var subdelay_typing = false;
  var volume_changing = false;
  var toggleSwitch;
  var obj = {};
  function checkMobile() {
    let check = false;
    (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
    return check;
  };
  var isMobile = checkMobile();

  function getSemitonesLabel(value) {
    if (value > 0) {
      return "+" + value + " semitones";
    } else {
      return value + " semitones";
    }
  }

  function getHHMMSS(value) {
  	return (new Date(value*1000)).toISOString().substr(11, 8);
  }

  function setImgSrc(img, src) {
  	if(img.attr('src')!=src)
  		img.attr('src', src)
  }

  function getNowPlaying() {
      $.get('{{ url_for("nowplaying") }}', function (data) {
      	if(!data) return;
        obj = JSON.parse(data);
        if (obj.now_playing) {
          var nowPlayingHtml = `<p style="margin-bottom: 5px">${obj.now_playing}</p>
            <p class="has-text-success" style="margin-bottom: 5px"><i class="icon icon-mic-1" title="Current singer"></i>${obj.now_playing_user}</p>`;

          if ($("#transpose")){
            if (obj.transpose_value != 0) {
              nowPlayingHtml +=
                "<span class='is-size-6 has-text-success'><b>Key</b>: " +
                getSemitonesLabel(obj.transpose_value) +
                "<span>";
            }
            if(!transpose_seeking){
              $("#transpose").val( obj.transpose_value );
              $("#semitones-label").html(getSemitonesLabel(obj.transpose_value));
            }
          }

          $("#now-playing").html(nowPlayingHtml);
          $(".control-box").show();

          if($("#seektrack") && !seektrack_seeking){
						$("#seektrack").attr({'max':obj.seektrack_max, 'value':obj.seektrack_value});
						$("#seektrack").val(obj.seektrack_value);
						$("#seektrack-val").text(getHHMMSS(obj.seektrack_value));
						$("#seektrack-max").text(getHHMMSS(obj.seektrack_max));
					}

					if(obj.audio_delay!==null && !audiodelay_typing)
						$("#delay-val").text(obj.audio_delay.toFixed(2));

					if("subtitle_delay" in obj){
						$("#subdelay-box").show();
						if(obj.subtitle_delay!==null && !subdelay_typing)
							$("#subdelay-val").text(obj.subtitle_delay.toFixed(1));
					} else {
						$("#subdelay-box").hide();
					}

					var use_DNN = obj.vocal_info&0x40;
					s3_enable(1, use_DNN?(obj.vocal_info&1):(obj.vocal_info&4));
					s3_enable(3, use_DNN?(obj.vocal_info&2):(obj.vocal_info&8));
					s3_go_to((obj.vocal_info>>4)&3, false);
					use_DNN ? $("#pytorch-logo").show():$("#pytorch-logo").hide();
        } else {
          $("#now-playing").html("Nothing is playing right now.");
          $(".control-box").hide();
        }

        if (obj.up_next) {
          $("#up-next").html(`<p style="margin-bottom: 5px">${obj.up_next}</p>
            <p class="has-text-success"><i class="icon icon-mic-1" title="Next singer"></i>${obj.next_user}</p>`);
        } else {
          $("#up-next").html("No song is queued.");
        }

        if (obj.is_paused) {
          $("#pause-resume").removeClass("icon-pause");
          $("#pause-resume").addClass("icon-play");
          setImgSrc($(".playing_gif"), '/static/images/now-playing.png');
        } else {
          $("#pause-resume").removeClass("icon-play");
          $("#pause-resume").addClass("icon-pause");
          setImgSrc($(".playing_gif"), '/static/images/now-playing.gif')
        }

				if("volume" in obj && !volume_changing)
	        $("#vol").text(obj.volume);
      });
    }

  function checkUser() {
  	try{ return obj.now_playing_user=='Randomizer' || $('#current-user').text().trim()==obj.now_playing_user; }
  	catch(err){ return false; }
  }

  $(function () {
    $(".control-box").hide();
    toggleSwitch = document.getElementsByClassName('redButton')[0];

    var slider = document.getElementById("transpose");
    var slider_prev_value = 0;
    var output = document.getElementById("semitones-label");
    if (slider) {
      // Update the current slider value (each time you drag the slider handle)
      slider.oninput = function () {
        output.innerHTML = getSemitonesLabel(slider.value);
      };
      slider.oninput()
      slider_prev_value = slider.value;
    }

    $("#transpose").change(function () {
      var value;
      if (slider) {
        value = slider.value;
      } else {
        value = 0;
      }
      if ( value != slider_prev_value ){
        $.get("/transpose/" + value);
        output.innerHTML = getSemitonesLabel(slider.value);
        slider_prev_value = value
      }
    });

		var seektrack = document.getElementById("seektrack");
		seektrack.onchange = function () {
			$.get("/seek/" + seektrack.value);
    };
    seektrack.oninput = function () {
			$("#seektrack-val").text(getHHMMSS(seektrack.value));
    };

    $("#pause-resume").click(function () {
      $.get("/pause", function (is_paused) {
				if (is_paused=="true") {
					$("#pause-resume").removeClass("icon-pause");
					$("#pause-resume").addClass("icon-play");
				} else {
					$("#pause-resume").removeClass("icon-play");
					$("#pause-resume").addClass("icon-pause");
				}
      });
    });

    $("#vol-up").click(function () {
      $.get("/vol_up", function(vol){$("#vol").text(vol)});
    });

    $("#vol-down").click(function () {
      $.get("/vol_down", function(vol){$("#vol").text(vol)});
    });

    $("#vol").keypress(function (e) {
			var ch = String.fromCharCode(e.which);
      if(!("0123456789".includes(ch))) e.preventDefault();
      if(ch=="\n" || ch=="\r") $(this).blur();
    });

    $("#vol").blur(function () {
    	$.get("/vol/"+$(this).text(), function(vol){$("#vol").text(vol)});
    	volume_changing = false;
    });

    $("#restart").click(function () {
      if (checkUser() || confirm("This song is not added by you. Are you sure you want to restart this track?")) {
        $.get("/restart");
      }
    });

    $("#skip").click(function () {
      if (checkUser() || confirm("This song is not added by you. Are you sure you want to skip this track?")) {
        $.get("/skip");
      }
    });

    $("#delay-val").keypress(function (e) {
    	var ch = String.fromCharCode(e.which);
      if(!("0123456789.-".includes(ch))) e.preventDefault();
      if(ch=="\n" || ch=="\r") $(this).blur();
    });

		$("#subdelay-val").keypress(function (e) {
    	var ch = String.fromCharCode(e.which);
      if(!("0123456789.-".includes(ch))) e.preventDefault();
      if(ch=="\n" || ch=="\r") $(this).blur();
    });

    $("#delay-val").blur(function () {
    	if($(this).text()=="") $(this).text("0");
    	$.get("/audio_delay/" + $(this).text());
    	audiodelay_typing=false;
    });

		$("#subdelay-val").blur(function () {
    	if($(this).text()=="") $(this).text("0");
    	$.get("/subtitle_delay/" + $(this).text());
    	subdelay_typing=false;
    });

    $("#delay-inc").click(function () {
    	$.get("/audio_delay/+", function(data){$("#delay-val").text(parseFloat(data).toFixed(2))});
    });

    $("#delay-dec").click(function () {
    	$.get("/audio_delay/-", function(data){$("#delay-val").text(parseFloat(data).toFixed(2))});
    });

    $("#subdelay-inc").click(function () {
    	$.get("/subtitle_delay/+", function(data){$("#subdelay-val").text(parseFloat(data).toFixed(1))});
    });

    $("#subdelay-dec").click(function () {
    	$.get("/subtitle_delay/-", function(data){$("#subdelay-val").text(parseFloat(data).toFixed(1))});
    });

    $("#audiodelay-info").click(function () {
      showNotification("Increasing audio delay will give you more time to read lyrics before singing out the next sentence.","is-info",8000)
    });

    $("#subdelay-info").click(function () {
      showNotification("Decreasing subtitle delay will give you more time to read lyrics before singing out the next sentence.","is-info",8000)
    });

    $("#semitones-info").click(function () {
      showNotification("A semitone is also known as a half-step. It is the smallest interval used in classical Western music, equal to a twelfth of an octave or half a tone.","is-info",10000)
    });

    $("#pytorch-logo").click(function () {
      showNotification("DNN-based vocal splitter is enabled. PiKaraoke uses PyTorch (by Facebook) to run a deep neural network to split instrumental and vocal sound in each track giving rise to stereo sound.","is-info",12000)
    });

    getNowPlaying();
    setInterval(getNowPlaying, 1500);
    if(isMobile)
    	$("#label-player-control")[0].outerHTML = '<h3 id="label-player-control">Player Control</h3>';
  });

	function s3_go_to(n, do_action) {
		if(n<1 || n>3) n=2;
		for(var i=1; i<=3; i++){
			if(i==n) toggleSwitch.classList.add('horizTranslate'+i);
			else toggleSwitch.classList.remove('horizTranslate'+i);
		}
		if(do_action)
			$.get("/play_vocal/"+(n==2?'both':(n==1?'nonvocal':'vocal')));
	}
	
	function s3_enable(n, val) {
		var s3t = document.getElementById("s3t"+n);
		if(val!=0){
			s3t.onclick = function(){s3_go_to(n, true)};
			s3t.style.color = '#ffffff';
		} else {
			s3t.onclick = null;
			s3t.style.color = '#444444';
		}
	}
</script>

{% endblock %} {% block header %}
<style>
hr, h1, h3, h4, p {
	padding-top: 0em;
	margin-top: 0em;
	margin-bottom: 0em;
}
body {
	line-height: 1;
}
.redButton.horizTranslate1 { -webkit-transition: -webkit-transform 0.1s linear; -webkit-transform: translateX(0px);}
.redButton.horizTranslate2 { -webkit-transition: -webkit-transform 0.1s linear; -webkit-transform: translateX(60px);}
.redButton.horizTranslate3 { -webkit-transition: -webkit-transform 0.1s linear; -webkit-transform: translateX(120px);}
.legendText{display:inline-block; width:50px; padding-bottom:33px; cursor:default; user-select: none;}
</style>
<h1>
	{% block title %}Now Playing
	<img
			class="playing_gif control-box"
			width="40"
			src="{{  url_for('static', filename='images/now-playing.png') }}"
	/>{% endblock %}
</h1>
{% endblock %} {% block content %}

<p class="is-size-4 has-text-warning" id="now-playing"></p>

<hr/>
<h3>Next Song</h3>
<p id="up-next" class="has-text-warning"></p>
<hr/>

{% if admin %}
<div class="has-background-black-bis box control-box" style="max-width: 500px">
	<div class="is-flex" style="justify-content: space-between">
		<h1 id="label-player-control">Player Control</h1>
		<img id="pytorch-logo" width="40" src="/static/images/pytorch-logo.png" />
		<div id="s3-outer" style="position:relative; width:150px; height:50px;">
				<div id="s3-inner" style="background-color: #222D41; width:150px; height:28px; left:0; position:relative; top:20px; border-radius:14px;">
						<div class="redButton horizTranslate2" style="width:16px; height:16px; background-color:#DB3D2B; border-radius:8px; position:relative; top:6px; left:6px;"></div>
				</div>

			 <div id="s3-text" class="is-flex" style="width:150px; display:inline-block; left:0; position:absolute; top:0;
			 		font-family:Arial; font-size:12pt; text-align:center; justify-content: space-between">
						<div id="s3t1" style="color:#ffffff" class="legendText" onclick="s3_go_to(1,true)">Music</div>
						<div id="s3t2" style="color:#ffffff" class="legendText" onclick="s3_go_to(2,true)">Both </div>
						<div id="s3t3" style="color:#ffffff" class="legendText" onclick="s3_go_to(3,true)">Voice</div>
				</div>
		</div>
	</div>

	<p class="is-size-3">
		<a title="Restart Song" id="restart"><i class="icon icon-to-start"></i> </a>&nbsp;&nbsp;
		<a title="Play/Pause"><i id="pause-resume" class="icon icon-pause"></i> </a>&nbsp;&nbsp;
		<a title="Stop Current Song" id="skip"><i class="icon icon-to-end"></i> </a>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;
		<span class="is-pulled-right">
      <a title="Volume Down" id="vol-down"><i class="icon icon-volume-down"></i> </a>
      <a title="Set Volume" id="vol" style="cursor: pointer" contenteditable="true" onfocus="volume_changing=true"> {{ volume }} </a>&nbsp;
      <a title="Volume Up" id="vol-up"><i class="icon icon-volume-up"></i> </a>
    </span>
	</p>

	<div id="subdelay-box">
		<div class="is-flex" style="justify-content: space-between">
			<h4>Subtitle Delay (sec)<a id="subdelay-info"> <i class="icon icon-info-circled-1" title="Info"></i></a>:</h4>
			<h4 title="Decrease Subtitle Delay" id="subdelay-dec" class="tabs" style="margin:0; color:red; cursor: pointer; font-weight: bold; font-size:x-large;" >&#x2296;</h4>
			<h4 title="Set Subtitle Delay" id="subdelay-val" class="tabs" style="padding-top:2px; margin:0; cursor: pointer" contenteditable="true" onfocus="subdelay_typing=true">0</h4>
			<h4 title="Increase Subtitle Delay" id="subdelay-inc" class="tabs" style="margin:0; color:green; cursor: pointer; font-weight:bold;font-size:x-large;" >&#x2295;</h4>
		</div>
	</div>

	<div class="is-flex" style="justify-content: space-between">
		<h4>Audio Delay (sec)<a id="audiodelay-info"> <i class="icon icon-info-circled-1" title="Info"></i></a>:</h4>
		<h4 title="Decrease Audio Delay" id="delay-dec" class="tabs" style="margin:0; color:red; cursor: pointer; font-weight: bold; font-size:x-large;" >&#x2296;</h4>
		<h4 title="Set Audio Delay" id="delay-val" class="tabs" style="padding-top:2px; margin:0; cursor: pointer" contenteditable="true" onfocus="audiodelay_typing=true">0</h4>
		<h4 title="Increase Audio Delay" id="delay-inc" class="tabs" style="margin:0; color:green; cursor: pointer; font-weight:bold;font-size:x-large;" >&#x2295;</h4>
	</div>

	<div class="is-flex" style="justify-content: space-between">
		<div><h4>Seek To:</h4></div>
		<a style="padding-top:6px" id="seektrack-val">00:00:00</a>
		<a style="padding-top:6px" id="seektrack-max">00:00:00</a>
	</div>

	<div style="width: 100%">
		<div class="is-flex">
			<input
					id="seektrack"
					type="range"
					min="0"
					max="{{ seektrack_max }}"
					value="{{ seektrack_value }}"
					width="300px"
					class="transpose-slider"
					style="width: 100%"
					onmousedown="seektrack_seeking=true"
					onmouseup="seektrack_seeking=false"
					ontouchstart="seektrack_seeking=true"
					ontouchend="seektrack_seeking=false"
			/>
		</div>
	</div>
	<!-- </div> -->

	{% if show_transpose %}
	<!-- <div class="has-background-black-bis box control-box" style="max-width: 500px"> -->
	<div class="is-flex" style="justify-content: space-between; padding-top: 1em">
		<div>
			<h4>Change Key</h4>
		</div>
		<div class="is-flex">
			<h4 id="semitones-label"></h4>
			<a id="semitones-info"> <i class="icon icon-info-circled-1" title="Info"></i></a>
		</div>
	</div>

	<div style="width: 100%">
		<div class="is-flex">
			<input
					id="transpose"
					type="range"
					min="-12"
					max="12"
					value="{{ transpose_value }}"
					width="300px"
					class="transpose-slider"
					style="width: 100%"
					onmousedown="transpose_seeking=true"
					onmouseup="transpose_seeking=false"
					ontouchstart="transpose_seeking=true"
					ontouchend="transpose_seeking=false"
			/>
		</div>
	</div>
</div>
{% endif %}

{% endif %}

{% endblock %}

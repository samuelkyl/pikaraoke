{% extends 'base.html' %} {% block scripts %}
<script>
  var transpose_seeking = false;
  var seektrack_seeking = false;
  var audiodelay_typing = false;
  var volume_changing = false;
  var obj = {};

  function getSemitonesLabel(value) {
    if (value > 0) {
      return "+" + value + " semitones";
    } else {
      return value + " semitones";
    }
  }

  function getHHMMSS(value) {
  	return (new Date(value*1000)).toISOString().substr(11, 8);
  }

  function setImgSrc(img, src) {
  	if(img.attr('src')!=src)
  		img.attr('src', src)
  }

  function getNowPlaying() {
      $.get('{{ url_for("nowplaying") }}', function (data) {
        obj = JSON.parse(data);
        if (obj.now_playing) {
          var nowPlayingHtml = `<p style="margin-bottom: 5px">${obj.now_playing}</p>
            <p class="has-text-success" style="margin-bottom: 5px"><i class="icon icon-mic-1" title="Current singer"></i>${obj.now_playing_user}</p>`;

          if ($("#transpose")){
            if (obj.transpose_value != 0) {
              nowPlayingHtml +=
                "<span class='is-size-6 has-text-success'><b>Key</b>: " +
                getSemitonesLabel(obj.transpose_value) +
                "<span>";
            }
            if(!transpose_seeking){
              $("#transpose").val( obj.transpose_value );
              $("#semitones-label").html(getSemitonesLabel(obj.transpose_value));
            }
          }

          $("#now-playing").html(nowPlayingHtml);
          $(".control-box").show();

          if($("#seektrack") && !seektrack_seeking){
						$("#seektrack").attr({'max':obj.seektrack_max, 'value':obj.seektrack_value});
						$("#seektrack").val(obj.seektrack_value);
						$("#seektrack-val").text(getHHMMSS(obj.seektrack_value));
						$("#seektrack-max").text(getHHMMSS(obj.seektrack_max));
					}

					if("audio_delay" in obj && !audiodelay_typing)
						$("#delay-val").text(obj.audio_delay.toFixed(2));
        } else {
          $("#now-playing").html("Nothing is playing right now.");
          $(".control-box").hide();
        }

        if (obj.up_next) {
          $("#up-next").html(`<p style="margin-bottom: 5px">${obj.up_next}</p>
            <p class="has-text-success"><i class="icon icon-mic-1" title="Next singer"></i>${obj.next_user}</p>`);
        } else {
          $("#up-next").html("No song is queued.");
        }

        if (obj.is_paused) {
          $("#pause-resume").removeClass("icon-pause");
          $("#pause-resume").addClass("icon-play");
          setImgSrc($(".playing_gif"), '/static/images/now-playing.png');
        } else {
          $("#pause-resume").removeClass("icon-play");
          $("#pause-resume").addClass("icon-pause");
          setImgSrc($(".playing_gif"), '/static/images/now-playing.gif')
        }

				if("volume" in obj && !volume_changing)
	        $("#vol").text(obj.volume);
      });
    }

  function checkUser() {
  	try{ return obj.now_playing_user=='Randomizer' || $('#current-user').text().trim()==obj.now_playing_user; }
  	catch(err){ return false; }
  }

  $(function () {
    $(".control-box").hide();

    var slider = document.getElementById("transpose");
    var slider_prev_value = 0;
    var output = document.getElementById("semitones-label");
    if (slider) {
      // Update the current slider value (each time you drag the slider handle)
      slider.oninput = function () {
        output.innerHTML = getSemitonesLabel(slider.value);
      };
      slider.oninput()
      slider_prev_value = slider.value;
    }

    $("#transpose").change(function () {
      var value;
      if (slider) {
        value = slider.value;
      } else {
        value = 0;
      }
      if ( value != slider_prev_value ){
        $.get("/transpose/" + value);
        output.innerHTML = getSemitonesLabel(slider.value);
        slider_prev_value = value
      }
    });

		var seektrack = document.getElementById("seektrack");
		seektrack.onchange = function () {
			$.get("/seek/" + seektrack.value);
    };
    seektrack.oninput = function () {
			$("#seektrack-val").text(getHHMMSS(seektrack.value));
    };

    $("#pause-resume").click(function () {
      $.get("/pause", function (is_paused) {
				if (is_paused=="true") {
					$("#pause-resume").removeClass("icon-pause");
					$("#pause-resume").addClass("icon-play");
				} else {
					$("#pause-resume").removeClass("icon-play");
					$("#pause-resume").addClass("icon-pause");
				}
      });
    });

    $("#vol-up").click(function () {
      $.get("/vol_up", function(vol){$("#vol").text(vol)});
    });

    $("#vol-down").click(function () {
      $.get("/vol_down", function(vol){$("#vol").text(vol)});
    });

    $("#vol").keypress(function (e) {
			var ch = String.fromCharCode(e.which);
      if(!("0123456789".includes(ch))) e.preventDefault();
      if(ch=="\n" || ch=="\r") $(this).blur();
    });

    $("#vol").blur(function () {
    	$.get("/vol/"+$(this).text(), function(vol){$("#vol").text(vol)});
    	volume_changing = false;
    });

    $("#restart").click(function () {
      if (checkUser() || confirm("This song is not added by you. Are you sure you want to restart this track?")) {
        $.get("/restart");
      }
    });

    $("#skip").click(function () {
      if (checkUser() || confirm("This song is not added by you. Are you sure you want to skip this track?")) {
        $.get("/skip");
      }
    });

    $("#delay-val").keypress(function (e) {
    	var ch = String.fromCharCode(e.which);
      if(!("0123456789.-".includes(ch))) e.preventDefault();
      if(ch=="\n" || ch=="\r") $(this).blur();
    });

    $("#delay-val").blur(function () {
    	if($(this).text()=="") $(this).text("0");
    	$.get("/audio_delay/" + $(this).text());
    	audiodelay_typing=false;
    });

    $("#delay-inc").click(function () {
    	$.get("/audio_delay/+", function(data){$("#delay-val").text(parseFloat(data).toFixed(2))});
    });

    $("#delay-dec").click(function () {
    	$.get("/audio_delay/-", function(data){$("#delay-val").text(parseFloat(data).toFixed(2))});
    });

    $("#semitones-info").click(function () {
      showNotification("A semitone is also known as a half-step. It is the smallest interval used in classical Western music, equal to a twelfth of an octave or half a tone.","is-info",10000)
    });

    getNowPlaying();
    setInterval(getNowPlaying, 1500);
  });
</script>

{% endblock %} {% block header %}
<style>
hr, h1, h3, h4, p {
	padding-top: 0em;
	margin-top: 0em;
	margin-bottom: 0em;
}
body {
	line-height: 1;
}
</style>
<h1>
	{% block title %}Now Playing
	<img
			class="playing_gif control-box"
			width="40"
			src="{{  url_for('static', filename='images/now-playing.png') }}"
	/>{% endblock %}
</h1>
{% endblock %} {% block content %}

<p class="is-size-4 has-text-warning" id="now-playing"></p>

<hr/>
<h3>Next Song</h3>
<p id="up-next" class="has-text-warning"></p>
<hr/>

{% if admin %}
<div class="has-background-black-bis box control-box" style="max-width: 500px">
	<h4>Player Control</h4>
	<p class="is-size-3">
		<a title="Restart Song" id="restart"><i class="icon icon-to-start"></i> </a>&nbsp;&nbsp;
		<a title="Play/Pause"><i id="pause-resume" class="icon icon-pause"></i> </a>&nbsp;&nbsp;
		<a title="Stop Current Song" id="skip"><i class="icon icon-to-end"></i> </a>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;
		<span class="is-pulled-right">
      <a title="Volume Down" id="vol-down"><i class="icon icon-volume-down"></i> </a>
      <a title="Set Volume" id="vol" style="cursor: pointer" contenteditable="true" onfocus="volume_changing=true"> {{ volume }} </a>&nbsp;
      <a title="Volume Up" id="vol-up"><i class="icon icon-volume-up"></i> </a>
    </span>
	</p>

	<div class="is-flex" style="justify-content: space-between">
		<h4>Audio Delay (sec):</h4>
		<h4 title="Decrease Audio Delay" id="delay-dec" class="tabs" style="margin:0; color:red; cursor: pointer; font-weight: bold; font-size:x-large;" >&#x2296;</h4>
		<h4 title="Set Audio Delay" id="delay-val" class="tabs" style="padding-top:2px; margin:0; cursor: pointer" contenteditable="true" onfocus="audiodelay_typing=true">0</h4>
		<h4 title="Increase Audio Delay" id="delay-inc" class="tabs" style="margin:0; color:green; cursor: pointer; font-weight:bold;font-size:x-large;" >&#x2295;</h4>
	</div>

	<div class="is-flex" style="justify-content: space-between">
		<div><h4>Seek To:</h4></div>
		<a style="padding-top:6px" id="seektrack-val">00:00:00</a>
		<a style="padding-top:6px" id="seektrack-max">00:00:00</a>
	</div>

	<div style="width: 100%">
		<div class="is-flex">
			<input
					id="seektrack"
					type="range"
					min="0"
					max="{{ seektrack_max }}"
					value="{{ seektrack_value }}"
					width="300px"
					class="transpose-slider"
					style="width: 100%"
					onmousedown="seektrack_seeking=true"
					onmouseup="seektrack_seeking=false"
					ontouchstart="seektrack_seeking=true"
					ontouchend="seektrack_seeking=false"
			/>
		</div>
	</div>
	<!-- </div> -->

	{% if show_transpose %}
	<!-- <div class="has-background-black-bis box control-box" style="max-width: 500px"> -->
	<div class="is-flex" style="justify-content: space-between; padding-top: 1em">
		<div>
			<h4>Change Key</h4>
		</div>
		<div class="is-flex">
			<h4 id="semitones-label"></h4>
			<a id="semitones-info"> <i class="icon icon-info-circled-1" title="Info"></i></a>
		</div>
	</div>

	<div style="width: 100%">
		<div class="is-flex">
			<input
					id="transpose"
					type="range"
					min="-12"
					max="12"
					value="{{ transpose_value }}"
					width="300px"
					class="transpose-slider"
					style="width: 100%"
					onmousedown="transpose_seeking=true"
					onmouseup="transpose_seeking=false"
					ontouchstart="transpose_seeking=true"
					ontouchend="transpose_seeking=false"
			/>
		</div>
	</div>
</div>
{% endif %}

{% endif %}

<div></div>
{% endblock %}
